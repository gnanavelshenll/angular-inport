"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var Rx_1 = require("rxjs/Rx");
var scroll_observable_1 = require("./utils/scroll-observable");
var offset_resolver_1 = require("./utils/offset-resolver");
var position_resolver_1 = require("./utils/position-resolver");
var viewport_ruler_1 = require("./utils/viewport-ruler");
;
var InviewDirective = (function () {
    function InviewDirective(_scrollObservable, _element, _zone, _windowRuler) {
        this._scrollObservable = _scrollObservable;
        this._element = _element;
        this._zone = _zone;
        this._windowRuler = _windowRuler;
        this._throttleType = 'debounce';
        this._offset = [0, 0, 0, 0];
        this._viewPortOffset = [0, 0, 0, 0];
        this._throttle = 0;
        this._lazy = false;
        this._tooLazy = false;
        this.inview = new core_1.EventEmitter();
    }
    Object.defineProperty(InviewDirective.prototype, "offset", {
        set: function (offset) {
            this._offset = offset_resolver_1.OffsetResolverFactory.create(offset).normalizeOffset();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(InviewDirective.prototype, "viewPortOffset", {
        set: function (offset) {
            this._viewPortOffset = offset_resolver_1.OffsetResolverFactory.create(offset).normalizeOffset();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(InviewDirective.prototype, "throttle", {
        set: function (throttle) {
            this._throttle = throttle;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(InviewDirective.prototype, "scrollELement", {
        set: function (sw) {
            this._scrollElement = sw;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(InviewDirective.prototype, "lazy", {
        set: function (lzy) {
            this._lazy = lzy;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(InviewDirective.prototype, "tooLazy", {
        set: function (lzy) {
            this._tooLazy = lzy;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(InviewDirective.prototype, "data", {
        set: function (_d) {
            this._data = _d;
        },
        enumerable: true,
        configurable: true
    });
    InviewDirective.prototype.ngAfterViewInit = function () {
        var _this = this;
        this._scrollerSubscription = this._scrollObservable.scrollObservableFor(this._scrollElement || window)[this._throttleType](function () { return Rx_1.Observable.timer(_this._throttle); })
            .filter(function () { return true; })
            .mergeMap(function (event) { return Rx_1.Observable.of(_this._getViewPortRuler()); })
            .subscribe(function (containersBounds) { return _this.handleOnScroll(containersBounds); });
    };
    InviewDirective.prototype._getViewPortRuler = function () {
        return this._scrollElement ? position_resolver_1.PositionResolver.getBoundingClientRect(this._scrollElement) : this._windowRuler.getWindowViewPortRuler();
    };
    InviewDirective.prototype.ngOnInit = function () { };
    InviewDirective.prototype.ngOnDestroy = function () {
        if (this._scrollerSubscription) {
            this._scrollerSubscription.unsubscribe();
        }
    };
    InviewDirective.prototype.handleOnScroll = function (containersBounds) {
        var _this = this;
        var viewPortOffsetRect = position_resolver_1.PositionResolver.offsetRect(containersBounds, this._viewPortOffset);
        var elementOffsetRect = position_resolver_1.PositionResolver.offsetRect(position_resolver_1.PositionResolver.getBoundingClientRect(this._element.nativeElement), this._offset);
        var isVisible = position_resolver_1.PositionResolver.isVisible(this._element.nativeElement) && position_resolver_1.PositionResolver.intersectRect(elementOffsetRect, viewPortOffsetRect);
        if (this._tooLazy && this._previous_state !== undefined && (this._previous_state === isVisible)) {
            return;
        }
        var output = { status: isVisible };
        if (this._data !== undefined) {
            output.data = this._data;
        }
        if (!this._lazy && !isVisible) {
            output.isClipped = false;
            output.isOutsideView = true;
            output.parts = { top: false, right: false, left: false, bottom: false };
            this._zone.run(function () { return _this.inview.emit(output); });
        }
        if (!isVisible) {
            this._previous_state = isVisible;
            return;
        }
        var _a = position_resolver_1.PositionResolver.clippedStatus(elementOffsetRect, viewPortOffsetRect), isClipped = _a.isClipped, isOutsideView = _a.isOutsideView;
        output.isClipped = isClipped;
        output.isOutsideView = isOutsideView;
        output.parts = position_resolver_1.PositionResolver.inViewParts(viewPortOffsetRect, elementOffsetRect);
        this._zone.run(function () { return _this.inview.emit(output); });
        this._previous_state = isVisible;
    };
    return InviewDirective;
}());
__decorate([
    core_1.Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], InviewDirective.prototype, "offset", null);
__decorate([
    core_1.Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], InviewDirective.prototype, "viewPortOffset", null);
__decorate([
    core_1.Input(),
    __metadata("design:type", Number),
    __metadata("design:paramtypes", [Number])
], InviewDirective.prototype, "throttle", null);
__decorate([
    core_1.Input(),
    __metadata("design:type", HTMLElement),
    __metadata("design:paramtypes", [HTMLElement])
], InviewDirective.prototype, "scrollELement", null);
__decorate([
    core_1.Input(),
    __metadata("design:type", Boolean),
    __metadata("design:paramtypes", [Boolean])
], InviewDirective.prototype, "lazy", null);
__decorate([
    core_1.Input(),
    __metadata("design:type", Boolean),
    __metadata("design:paramtypes", [Boolean])
], InviewDirective.prototype, "tooLazy", null);
__decorate([
    core_1.Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], InviewDirective.prototype, "data", null);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], InviewDirective.prototype, "inview", void 0);
InviewDirective = __decorate([
    core_1.Directive({
        selector: '[in-view]'
    }),
    __metadata("design:paramtypes", [scroll_observable_1.ScrollObservable,
        core_1.ElementRef,
        core_1.NgZone,
        viewport_ruler_1.WindowRuler])
], InviewDirective);
exports.InviewDirective = InviewDirective;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW52aWV3LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9pbnZpZXcuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUEsc0NBQTZIO0FBQzdILDhCQUFtRDtBQUNuRCwrREFBNkQ7QUFDN0QsMkRBQWdFO0FBQ2hFLCtEQUE2RDtBQUU3RCx5REFBcUQ7QUFBQSxDQUFDO0FBS3RELElBQWEsZUFBZTtJQTBDMUIseUJBQ1UsaUJBQW1DLEVBQ25DLFFBQW9CLEVBQ3BCLEtBQWEsRUFDYixZQUF5QjtRQUh6QixzQkFBaUIsR0FBakIsaUJBQWlCLENBQWtCO1FBQ25DLGFBQVEsR0FBUixRQUFRLENBQVk7UUFDcEIsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUNiLGlCQUFZLEdBQVosWUFBWSxDQUFhO1FBN0MzQixrQkFBYSxHQUFXLFVBQVUsQ0FBQztRQUNuQyxZQUFPLEdBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdEMsb0JBQWUsR0FBa0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM5QyxjQUFTLEdBQVcsQ0FBQyxDQUFDO1FBRXRCLFVBQUssR0FBWSxLQUFLLENBQUM7UUFDdkIsYUFBUSxHQUFZLEtBQUssQ0FBQztRQWdDaEIsV0FBTSxHQUFzQixJQUFJLG1CQUFZLEVBQUUsQ0FBQztJQU8xQixDQUFDO0lBbEN4QyxzQkFBSSxtQ0FBTTthQUFWLFVBQVcsTUFBOEI7WUFDdkMsSUFBSSxDQUFDLE9BQU8sR0FBRyx1Q0FBcUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDeEUsQ0FBQzs7O09BQUE7SUFFRCxzQkFBSSwyQ0FBYzthQUFsQixVQUFtQixNQUE4QjtZQUMvQyxJQUFJLENBQUMsZUFBZSxHQUFHLHVDQUFxQixDQUFDLE1BQU0s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SSxDQUFDLE1BQU0sQ0FBQyxFQUF4QixDQUF3QixDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLGVBQWUsR0FBRyxTQUFTLENBQUM7SUFDbkMsQ0FBQztJQUNILHNCQUFDO0FBQUQsQ0FBQyxBQS9GRCxJQStGQztBQW5GQztJQURDLFlBQUssRUFBRTs7OzZDQUdQO0FBRUQ7SUFEQyxZQUFLLEVBQUU7OztxREFHUDtBQUVEO0lBREMsWUFBSyxFQUFFOzs7K0NBR1A7QUFFRDtJQURDLFlBQUssRUFBRTs4QkFDYyxXQUFXO3FDQUFYLFdBQVc7b0RBRWhDO0FBRUQ7SUFEQyxZQUFLLEVBQUU7OzsyQ0FHUDtBQUVEO0lBREMsWUFBSyxFQUFFOzs7OENBR1A7QUFFRDtJQURDLFlBQUssRUFBRTs7OzJDQUdQO0FBQ1M7SUFBVCxhQUFNLEVBQUU7OEJBQWlCLG1CQUFZOytDQUEyQjtBQXZDdEQsZUFBZTtJQUgzQixnQkFBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLFdBQVc7S0FDdEIsQ0FBQztxQ0E0QzZCLG9DQUFnQjtRQUN6QixpQkFBVTtRQUNiLGFBQU07UUFDQyw0QkFBVztHQTlDeEIsZUFBZSxDQStGM0I7QUEvRlksMENBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIElucHV0LCBPdXRwdXQsIE9uSW5pdCwgT25EZXN0cm95LCBFdmVudEVtaXR0ZXIsIEVsZW1lbnRSZWYsIE5nWm9uZSwgQWZ0ZXJWaWV3SW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcy9SeCc7XG5pbXBvcnQgeyBTY3JvbGxPYnNlcnZhYmxlIH0gZnJvbSAnLi91dGlscy9zY3JvbGwtb2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBPZmZzZXRSZXNvbHZlckZhY3RvcnkgfSBmcm9tICcuL3V0aWxzL29mZnNldC1yZXNvbHZlcic7XG5pbXBvcnQgeyBQb3NpdGlvblJlc29sdmVyIH0gZnJvbSAnLi91dGlscy9wb3NpdGlvbi1yZXNvbHZlcic7XG5pbXBvcnQgeyBFbGVtZW50Qm91bmRpbmdQb3NpdGlvbnMgfSBmcm9tICcuL3V0aWxzL21vZGVscyc7XG5pbXBvcnQgeyBXaW5kb3dSdWxlciB9IGZyb20gJy4vdXRpbHMvdmlld3BvcnQtcnVsZXInOztcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW2luLXZpZXddJ1xufSlcbmV4cG9ydCBjbGFzcyBJbnZpZXdEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCB7XG4gIHByaXZhdGUgX3Rocm90dGxlVHlwZTogc3RyaW5nID0gJ2RlYm91bmNlJztcbiAgcHJpdmF0ZSBfb2Zmc2V0OiBBcnJheTxudW1iZXI+ID0gWzAsIDAsIDAsIDBdO1xuICBwcml2YXRlIF92aWV3UG9ydE9mZnNldDogQXJyYXk8bnVtYmVyPiA9IFswLCAwLCAwLCAwXTtcbiAgcHJpdmF0ZSBfdGhyb3R0bGU6IG51bWJlciA9IDA7XG4gIHByaXZhdGUgX3Njcm9sbEVsZW1lbnQ6IEhUTUxFbGVtZW50O1xuICBwcml2YXRlIF9sYXp5OiBib29sZWFuID0gZmFsc2U7IC8vIHdoZW4gdmlzaWJsZSBvbmx5IHRoZW4uXG4gIHByaXZhdGUgX3Rvb0xhenk6IGJvb2xlYW4gPSBmYWxzZTsgLy8gd2hlbiBzdGF0ZSBjaGFuZ2VzIG9ubHkgdGhlbi5cbiAgcHJpdmF0ZSBfcHJldmlvdXNfc3RhdGU6IGJvb2xlYW47XG4gIHByaXZhdGUgX2RhdGE6IGFueTtcblxuICBASW5wdXQoKVxuICBzZXQgb2Zmc2V0KG9mZnNldDogQXJyYXk8bnVtYmVyPiB8IG51bWJlcikge1xuICAgIHRoaXMuX29mZnNldCA9IE9mZnNldFJlc29sdmVyRmFjdG9yeS5jcmVhdGUob2Zmc2V0KS5ub3JtYWxpemVPZmZzZXQoKTtcbiAgfVxuICBASW5wdXQoKVxuICBzZXQgdmlld1BvcnRPZmZzZXQob2Zmc2V0OiBBcnJheTxudW1iZXI+IHwgbnVtYmVyKSB7XG4gICAgdGhpcy5fdmlld1BvcnRPZmZzZXQgPSBPZmZzZXRSZXNvbHZlckZhY3RvcnkuY3JlYXRlKG9mZnNldCkubm9ybWFsaXplT2Zmc2V0KCk7XG4gIH1cbiAgQElucHV0KClcbiAgc2V0IHRocm90dGxlKHRocm90dGxlOiBudW1iZXIpIHtcbiAgICB0aGlzLl90aHJvdHRsZSA9IHRocm90dGxlO1xuICB9XG4gIEBJbnB1dCgpXG4gIHNldCBzY3JvbGxFTGVtZW50KHN3OiBIVE1MRWxlbWVudCkge1xuICAgIHRoaXMuX3Njcm9sbEVsZW1lbnQgPSBzdztcbiAgfVxuICBASW5wdXQoKVxuICBzZXQgbGF6eShsenk6IGJvb2xlYW4pIHtcbiAgICB0aGlzLl9sYXp5ID0gbHp5O1xuICB9XG4gIEBJbnB1dCgpXG4gIHNldCB0b29MYXp5KGx6eTogYm9vbGVhbikge1xuICAgIHRoaXMuX3Rvb0xhenkgPSBsenk7XG4gIH1cbiAgQElucHV0KClcbiAgc2V0IGRhdGEoX2Q6IGFueSkge1xuICAgIHRoaXMuX2RhdGEgPSBfZDtcbiAgfVxuICBAT3V0cHV0KCkgcHJpdmF0ZSBpbnZpZXc6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBwcml2YXRlIF9zY3JvbGxlclN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX3Njcm9sbE9ic2VydmFibGU6IFNjcm9sbE9ic2VydmFibGUsXG4gICAgcHJpdmF0ZSBfZWxlbWVudDogRWxlbWVudFJlZixcbiAgICBwcml2YXRlIF96b25lOiBOZ1pvbmUsXG4gICAgcHJpdmF0ZSBfd2luZG93UnVsZXI6IFdpbmRvd1J1bGVyKSB7IH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdGhpcy5fc2Nyb2xsZXJTdWJzY3JpcHRpb24gPSB0aGlzLl9zY3JvbGxPYnNlcnZhYmxlLnNjcm9sbE9ic2VydmFibGVGb3IodGhpcy5fc2Nyb2xsRWxlbWVudCB8fCB3aW5kb3cpXG4gICAgW3RoaXMuX3Rocm90dGxlVHlwZV0oKCkgPT4gT2JzZXJ2YWJsZS50aW1lcih0aGlzLl90aHJvdHRsZSkpXG4gICAgICAuZmlsdGVyKCgpID0+IHRydWUpXG4gICAgICAubWVyZ2VNYXAoKGV2ZW50OiBhbnkpID0+IE9ic2VydmFibGUub2YodGhpcy5fZ2V0Vmlld1BvcnRSdWxlcigpKSlcbiAgICAgIC5zdWJzY3JpYmUoKGNvbnRhaW5lcnNCb3VuZHM6IEVsZW1lbnRCb3VuZGluZ1Bvc2l0aW9ucykgPT4gdGhpcy5oYW5kbGVPblNjcm9sbChjb250YWluZXJzQm91bmRzKSk7XG4gIH1cblxuICBwcml2YXRlIF9nZXRWaWV3UG9ydFJ1bGVyICgpIHtcbiAgICByZXR1cm4gdGhpcy5fc2Nyb2xsRWxlbWVudCA/IFBvc2l0aW9uUmVzb2x2ZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KHRoaXMuX3Njcm9sbEVsZW1lbnQpIDogdGhpcy5fd2luZG93UnVsZXIuZ2V0V2luZG93Vmlld1BvcnRSdWxlcigpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7IH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5fc2Nyb2xsZXJTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuX3Njcm9sbGVyU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlT25TY3JvbGwoY29udGFpbmVyc0JvdW5kczogRWxlbWVudEJvdW5kaW5nUG9zaXRpb25zKSB7XG4gICAgbGV0IHZpZXdQb3J0T2Zmc2V0UmVjdCA9IFBvc2l0aW9uUmVzb2x2ZXIub2Zmc2V0UmVjdChjb250YWluZXJzQm91bmRzLCB0aGlzLl92aWV3UG9ydE9mZnNldCk7XG4gICAgbGV0IGVsZW1lbnRPZmZzZXRSZWN0ID0gUG9zaXRpb25SZXNvbHZlci5vZmZzZXRSZWN0KFBvc2l0aW9uUmVzb2x2ZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KHRoaXMuX2VsZW1lbnQubmF0aXZlRWxlbWVudCksIHRoaXMuX29mZnNldCk7XG4gICAgbGV0IGlzVmlzaWJsZSA9IFBvc2l0aW9uUmVzb2x2ZXIuaXNWaXNpYmxlKHRoaXMuX2VsZW1lbnQubmF0aXZlRWxlbWVudCkgJiYgUG9zaXRpb25SZXNvbHZlci5pbnRlcnNlY3RSZWN0KGVsZW1lbnRPZmZzZXRSZWN0LCB2aWV3UG9ydE9mZnNldFJlY3QpO1xuXG4gICAgaWYgKHRoaXMuX3Rvb0xhenkgJiYgdGhpcy5fcHJldmlvdXNfc3RhdGUgIT09IHVuZGVmaW5lZCAmJiAodGhpcy5fcHJldmlvdXNfc3RhdGUgPT09IGlzVmlzaWJsZSkpIHsgcmV0dXJuOyB9XG5cbiAgICBsZXQgb3V0cHV0OiBhbnkgPSB7IHN0YXR1czogaXNWaXNpYmxlIH07XG5cbiAgICBpZiAodGhpcy5fZGF0YSAhPT0gdW5kZWZpbmVkKSB7IG91dHB1dC5kYXRhID0gdGhpcy5fZGF0YTsgfVxuXG4gICAgaWYgKCF0aGlzLl9sYXp5ICYmICFpc1Zpc2libGUpIHtcbiAgICAgIG91dHB1dC5pc0NsaXBwZWQgPSBmYWxzZTtcbiAgICAgIG91dHB1dC5pc091dHNpZGVWaWV3ID0gdHJ1ZTtcbiAgICAgIG91dHB1dC5wYXJ0cyA9IHsgdG9wOiBmYWxzZSwgcmlnaHQ6IGZhbHNlLCBsZWZ0OiBmYWxzZSwgYm90dG9tOiBmYWxzZSB9O1xuICAgICAgdGhpcy5fem9uZS5ydW4oKCkgPT4gdGhpcy5pbnZpZXcuZW1pdChvdXRwdXQpKTtcbiAgICB9XG5cbiAgICBpZiAoIWlzVmlzaWJsZSkgeyB0aGlzLl9wcmV2aW91c19zdGF0ZSA9IGlzVmlzaWJsZTsgcmV0dXJuOyB9XG5cbiAgICBsZXQgeyBpc0NsaXBwZWQsIGlzT3V0c2lkZVZpZXcgfSA9IFBvc2l0aW9uUmVzb2x2ZXIuY2xpcHBlZFN0YXR1cyhlbGVtZW50T2Zmc2V0UmVjdCwgdmlld1BvcnRPZmZzZXRSZWN0KTtcbiAgICBvdXRwdXQuaXNDbGlwcGVkID0gaXNDbGlwcGVkO1xuICAgIG91dHB1dC5pc091dHNpZGVWaWV3ID0gaXNPdXRzaWRlVmlldztcbiAgICBvdXRwdXQucGFydHMgPSBQb3NpdGlvblJlc29sdmVyLmluVmlld1BhcnRzKHZpZXdQb3J0T2Zmc2V0UmVjdCwgZWxlbWVudE9mZnNldFJlY3QpO1xuICAgIHRoaXMuX3pvbmUucnVuKCgpID0+IHRoaXMuaW52aWV3LmVtaXQob3V0cHV0KSk7XG4gICAgdGhpcy5fcHJldmlvdXNfc3RhdGUgPSBpc1Zpc2libGU7XG4gIH1cbn1cbiJdfQ==