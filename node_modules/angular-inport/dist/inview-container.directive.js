"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var Rx_1 = require("rxjs/Rx");
var inview_item_directive_1 = require("./inview-item.directive");
var scroll_observable_1 = require("./utils/scroll-observable");
var viewport_ruler_1 = require("./utils/viewport-ruler");
var offset_resolver_1 = require("./utils/offset-resolver");
var position_resolver_1 = require("./utils/position-resolver");
var InviewContainerDirective = (function () {
    function InviewContainerDirective(_element, _scrollObservable, _windowRuler, _zone) {
        this._element = _element;
        this._scrollObservable = _scrollObservable;
        this._windowRuler = _windowRuler;
        this._zone = _zone;
        this._throttleType = 'debounce';
        this._offset = [0, 0, 0, 0];
        this._viewPortOffset = [0, 0, 0, 0];
        this._throttle = 0;
        this._scrollWindow = true;
        this._lastScrollY = 0;
        this._scrollDirection = 'down';
        this.inview = new core_1.EventEmitter();
    }
    Object.defineProperty(InviewContainerDirective.prototype, "offset", {
        set: function (offset) {
            this._offset = offset_resolver_1.OffsetResolverFactory.create(offset).normalizeOffset();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(InviewContainerDirective.prototype, "viewPortOffset", {
        set: function (offset) {
            this._viewPortOffset = offset_resolver_1.OffsetResolverFactory.create(offset).normalizeOffset();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(InviewContainerDirective.prototype, "throttle", {
        set: function (throttle) {
            this._throttle = throttle;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(InviewContainerDirective.prototype, "scrollWindow", {
        set: function (sw) {
            this._scrollWindow = !!sw;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(InviewContainerDirective.prototype, "data", {
        set: function (_d) {
            this._data = _d;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(InviewContainerDirective.prototype, "bestMatch", {
        set: function (bm) {
            this._bestMatch = !!bm;
        },
        enumerable: true,
        configurable: true
    });
    InviewContainerDirective.prototype.ngOnInit = function () { };
    InviewContainerDirective.prototype.ngAfterViewInit = function () {
        var _this = this;
        this._scrollSuscription = this._scrollObservable.scrollObservableFor(this._scrollWindow ? window : this._element.nativeElement)[this._throttleType](function () { return Rx_1.Observable.timer(_this._throttle); })
            .filter(function () { return true; })
            .mergeMap(function (event) { return Rx_1.Observable.of(_this._getViewPortRuler()); })
            .do(function () { return _this._checkScrollDirection(); })
            .subscribe(function (containersBounds) { return _this.handleOnScroll(containersBounds); });
    };
    InviewContainerDirective.prototype._checkScrollDirection = function () {
        if (this._scrollWindow) {
            this._scrollDirection = (window.scrollY > this._lastScrollY) ? 'down' : 'up';
            this._lastScrollY = window.scrollY;
        }
        else {
            this._scrollDirection = (this._element.nativeElement.scrollTop > this._lastScrollY) ? 'down' : 'up';
            this._lastScrollY = this._element.nativeElement.scrollTop;
        }
    };
    InviewContainerDirective.prototype._getViewPortRuler = function () {
        return this._scrollWindow ? this._windowRuler.getWindowViewPortRuler() : position_resolver_1.PositionResolver.getBoundingClientRect(this._element.nativeElement);
    };
    InviewContainerDirective.prototype.ngOnDestroy = function () {
        if (this._scrollSuscription) {
            this._scrollSuscription.unsubscribe();
        }
    };
    InviewContainerDirective.prototype.handleOnScroll = function (containersBounds) {
        var _this = this;
        var viewPortOffsetRect = position_resolver_1.PositionResolver.offsetRect(containersBounds, this._viewPortOffset);
        var visibleChildren = [];
        if (this._inviewChildren) {
            visibleChildren = this._inviewChildren.toArray().filter(function (child) {
                var elementOffsetRect = position_resolver_1.PositionResolver.offsetRect(child.getELementRect(), _this._offset);
                return child.isVisible() && position_resolver_1.PositionResolver.intersectRect(elementOffsetRect, viewPortOffsetRect);
            });
            if (this._bestMatch) {
                var bestMatchChild_1;
                if (visibleChildren.length) {
                    visibleChildren.reduce(function (distance, currChild) {
                        var _distance = position_resolver_1.PositionResolver.distance(viewPortOffsetRect, position_resolver_1.PositionResolver.offsetRect(currChild.getELementRect(), _this._offset));
                        if (distance > _distance) {
                            bestMatchChild_1 = currChild;
                            return _distance;
                        }
                        return distance;
                    }, Infinity);
                }
                var data_1 = bestMatchChild_1 ? bestMatchChild_1.getData() : {};
                data_1.direction = this._scrollDirection;
                this._zone.run(function () { return _this.inview.emit(data_1); });
            }
            else {
                var data_2 = {};
                data_2.inview = visibleChildren.map(function (vc) { return vc.getData(); });
                data_2.direction = this._scrollDirection;
                this._zone.run(function () { return _this.inview.emit(data_2); });
            }
        }
    };
    return InviewContainerDirective;
}());
__decorate([
    core_1.Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], InviewContainerDirective.prototype, "offset", null);
__decorate([
    core_1.Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], InviewContainerDirective.prototype, "viewPortOffset", null);
__decorate([
    core_1.Input(),
    __metadata("design:type", Number),
    __metadata("design:paramtypes", [Number])
], InviewContainerDirective.prototype, "throttle", null);
__decorate([
    core_1.Input(),
    __metadata("design:type", Boolean),
    __metadata("design:paramtypes", [Boolean])
], InviewContainerDirective.prototype, "scrollWindow", null);
__decorate([
    core_1.Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], InviewContainerDirective.prototype, "data", null);
__decorate([
    core_1.Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], InviewContainerDirective.prototype, "bestMatch", null);
__decorate([
    core_1.Output(),
    __metadata("design:type", core_1.EventEmitter)
], InviewContainerDirective.prototype, "inview", void 0);
__decorate([
    core_1.ContentChildren(inview_item_directive_1.InviewItemDirective),
    __metadata("design:type", core_1.QueryList)
], InviewContainerDirective.prototype, "_inviewChildren", void 0);
InviewContainerDirective = __decorate([
    core_1.Directive({
        selector: '[in-view-container]'
    }),
    __metadata("design:paramtypes", [core_1.ElementRef,
        scroll_observable_1.ScrollObservable,
        viewport_ruler_1.WindowRuler,
        core_1.NgZone])
], InviewContainerDirective);
exports.InviewContainerDirective = InviewContainerDirective;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW52aWV3LWNvbnRhaW5lci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW52aWV3LWNvbnRhaW5lci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQSxzQ0FBeUo7QUFDekosOEJBQW1EO0FBRW5ELGlFQUE4RDtBQUM5RCwrREFBNkQ7QUFDN0QseURBQXFEO0FBQ3JELDJEQUFnRTtBQUNoRSwrREFBNkQ7QUFlN0QsSUFBYSx3QkFBd0I7SUF3Q25DLGtDQUNVLFFBQW9CLEVBQ3BCLGlCQUFtQyxFQUNuQyxZQUF5QixFQUN6QixLQUFhO1FBSGIsYUFBUSxHQUFSLFFBQVEsQ0FBWTtRQUNwQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQWtCO1FBQ25DLGlCQUFZLEdBQVosWUFBWSxDQUFhO1FBQ3pCLFVBQUssR0FBTCxLQUFLLENBQVE7UUExQ2Ysa0JBQWEsR0FBVyxVQUFVLENBQUM7UUFDbkMsWUFBTyxHQUFrQixDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLG9CQUFlLEdBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDOUMsY0FBUyxHQUFXLENBQUMsQ0FBQztRQUN0QixrQkFBYSxHQUFZLElBQUksQ0FBQztRQUc5QixpQkFBWSxHQUFXLENBQUMsQ0FBQztRQUN6QixxQkFBZ0IsR0FBVyxNQUFNLENBQUM7UUEyQmhDLFdBQU0sR0FBc0IsSUFBSSxtQkFBWSxFQUFFLENBQUM7SUFRckQsQ0FBQztJQWhDTCxzQkFBSSw0Q0FBTTthQUFWLFVBQVcsTUFBOEI7WUFDdkMsSUFBSSxDQUFDLE9BQU8sR0FBRyx1Q0FBcUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDeEUsQ0FBQzs7O09BQUE7SUFFRCxzQkFBSSxvREFBYzthQUFsQixV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d0RBQTJCO0FBQ25CO0lBQXJDLHNCQUFlLENBQUMsMkNBQW1CLENBQUM7OEJBQTBCLGdCQUFTO2lFQUFzQjtBQXRDbkYsd0JBQXdCO0lBSHBDLGdCQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUscUJBQXFCO0tBQ2hDLENBQUM7cUNBMENvQixpQkFBVTtRQUNELG9DQUFnQjtRQUNyQiw0QkFBVztRQUNsQixhQUFNO0dBNUNaLHdCQUF3QixDQWlIcEM7QUFqSFksNERBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBDb250ZW50Q2hpbGRyZW4sIFF1ZXJ5TGlzdCwgT25Jbml0LCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQsIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgRWxlbWVudFJlZiwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzL1J4JztcblxuaW1wb3J0IHsgSW52aWV3SXRlbURpcmVjdGl2ZSB9IGZyb20gJy4vaW52aWV3LWl0ZW0uZGlyZWN0aXZlJztcbmltcG9ydCB7IFNjcm9sbE9ic2VydmFibGUgfSBmcm9tICcuL3V0aWxzL3Njcm9sbC1vYnNlcnZhYmxlJztcbmltcG9ydCB7IFdpbmRvd1J1bGVyIH0gZnJvbSAnLi91dGlscy92aWV3cG9ydC1ydWxlcic7XG5pbXBvcnQgeyBPZmZzZXRSZXNvbHZlckZhY3RvcnkgfSBmcm9tICcuL3V0aWxzL29mZnNldC1yZXNvbHZlcic7XG5pbXBvcnQgeyBQb3NpdGlvblJlc29sdmVyIH0gZnJvbSAnLi91dGlscy9wb3NpdGlvbi1yZXNvbHZlcic7XG5pbXBvcnQgeyBFbGVtZW50Qm91bmRpbmdQb3NpdGlvbnMgfSBmcm9tICcuL3V0aWxzL21vZGVscyc7XG4vLyBhbGxtb3N0IHNhbWUgY29uZmlndXJhdGlvbiBhcyBjaGlsZFxuLy8gY2hpbGQgd2lsbCBub3QgaGF2ZSBpbnZpZXcgcHJvcGVydHk/IHRvIHRyaWdnZXIgY2hhbmdlc1xuLy8gd2lsbCB1c2Ugc2Nyb2xsIG9uIHRoaXMgb3Igd2luZG93XG4vLyB3aWxsIGNoZWNrIHdoZWF0aGVyIHRoZSBjaGlsZCBpcyBpbiB2aWV3IHBvcnRcbi8vIHdpbGwgc3RhcnQgY2hlY2tpbmcgZnJvbSBsYXN0IGludmlldyBjaGlsZCBhbmQgd2l0aCBkaXJlY3Rpb24gb2Ygc2Nyb2xsIHVudGlsIGEgY2hpbGQgaXMgbm90IHZpc2libGVcbi8vIGNhbiByZXR1cm4gYWxsIGludmlldyBjaGlsZHJlblxuLy8gb3IgYmVzdCBtYXRjaCBjYXNlXG4vLyBpZiBjb250YWluZXIgaXMgdXNlZCB0aGVuIGZpcnN0IGNoZWNrIGlmIGNvbnRhaW5lciBpdHNlbGYgaXMgaW4gdGhlIHZpZXdwb3J0IG9mIHRoZSB3aW5kb3cuXG4vLyB0aGVuIG9ubHkgdGhlIGZ1dGhlciBjYWxjdWxhdGlvbiBzaG91bGQgdGFrZSBwbGFjZVxuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbaW4tdmlldy1jb250YWluZXJdJ1xufSlcbmV4cG9ydCBjbGFzcyBJbnZpZXdDb250YWluZXJEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCB7XG4gIHByaXZhdGUgX3Njcm9sbFN1c2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgX3Rocm90dGxlVHlwZTogc3RyaW5nID0gJ2RlYm91bmNlJztcbiAgcHJpdmF0ZSBfb2Zmc2V0OiBBcnJheTxudW1iZXI+ID0gWzAsIDAsIDAsIDBdO1xuICBwcml2YXRlIF92aWV3UG9ydE9mZnNldDogQXJyYXk8bnVtYmVyPiA9IFswLCAwLCAwLCAwXTtcbiAgcHJpdmF0ZSBfdGhyb3R0bGU6IG51bWJlciA9IDA7XG4gIHByaXZhdGUgX3Njcm9sbFdpbmRvdzogYm9vbGVhbiA9IHRydWU7XG4gIHByaXZhdGUgX2RhdGE6IGFueTtcbiAgcHJpdmF0ZSBfYmVzdE1hdGNoOiBib29sZWFuO1xuICBwcml2YXRlIF9sYXN0U2Nyb2xsWTogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBfc2Nyb2xsRGlyZWN0aW9uOiBzdHJpbmcgPSAnZG93bic7XG5cbiAgQElucHV0KClcbiAgc2V0IG9mZnNldChvZmZzZXQ6IEFycmF5PG51bWJlcj4gfCBudW1iZXIpIHtcbiAgICB0aGlzLl9vZmZzZXQgPSBPZmZzZXRSZXNvbHZlckZhY3RvcnkuY3JlYXRlKG9mZnNldCkubm9ybWFsaXplT2Zmc2V0KCk7XG4gIH1cbiAgQElucHV0KClcbiAgc2V0IHZpZXdQb3J0T2Zmc2V0KG9mZnNldDogQXJyYXk8bnVtYmVyPiB8IG51bWJlcikge1xuICAgIHRoaXMuX3ZpZXdQb3J0T2Zmc2V0ID0gT2Zmc2V0UmVzb2x2ZXJGYWN0b3J5LmNyZWF0ZShvZmZzZXQpLm5vcm1hbGl6ZU9mZnNldCgpO1xuICB9XG4gIEBJbnB1dCgpXG4gIHNldCB0aHJvdHRsZSh0aHJvdHRsZTogbnVtYmVyKSB7XG4gICAgdGhpcy5fdGhyb3R0bGUgPSB0aHJvdHRsZTtcbiAgfVxuICBASW5wdXQoKVxuICBzZXQgc2Nyb2xsV2luZG93KHN3OiBib29sZWFuKSB7XG4gICAgdGhpcy5fc2Nyb2xsV2luZG93ID0gISFzdztcbiAgfVxuICBASW5wdXQoKVxuICBzZXQgZGF0YShfZDogYW55KSB7XG4gICAgdGhpcy5fZGF0YSA9IF9kO1xuICB9XG4gIEBJbnB1dCgpXG4gIHNldCBiZXN0TWF0Y2goYm06IGFueSkge1xuICAgIHRoaXMuX2Jlc3RNYXRjaCA9ICEhYm07XG4gIH1cblxuICBAT3V0cHV0KCkgaW52aWV3OiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQENvbnRlbnRDaGlsZHJlbihJbnZpZXdJdGVtRGlyZWN0aXZlKSBwcml2YXRlIF9pbnZpZXdDaGlsZHJlbjogUXVlcnlMaXN0PEludmlld0l0ZW1EaXJlY3RpdmU+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX2VsZW1lbnQ6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSBfc2Nyb2xsT2JzZXJ2YWJsZTogU2Nyb2xsT2JzZXJ2YWJsZSxcbiAgICBwcml2YXRlIF93aW5kb3dSdWxlcjogV2luZG93UnVsZXIsXG4gICAgcHJpdmF0ZSBfem9uZTogTmdab25lXG4gICkgeyB9XG5cbiAgbmdPbkluaXQoKSB7IH1cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHRoaXMuX3Njcm9sbFN1c2NyaXB0aW9uID0gdGhpcy5fc2Nyb2xsT2JzZXJ2YWJsZS5zY3JvbGxPYnNlcnZhYmxlRm9yKHRoaXMuX3Njcm9sbFdpbmRvdz93aW5kb3c6IHRoaXMuX2VsZW1lbnQubmF0aXZlRWxlbWVudClcbiAgICBbdGhpcy5fdGhyb3R0bGVUeXBlXSgoKSA9PiBPYnNlcnZhYmxlLnRpbWVyKHRoaXMuX3Rocm90dGxlKSlcbiAgICAgIC5maWx0ZXIoKCkgPT4gdHJ1ZSlcbiAgICAgIC5tZXJnZU1hcCgoZXZlbnQ6IGFueSkgPT4gT2JzZXJ2YWJsZS5vZih0aGlzLl9nZXRWaWV3UG9ydFJ1bGVyKCkpKVxuICAgICAgLmRvKCgpPT4gdGhpcy5fY2hlY2tTY3JvbGxEaXJlY3Rpb24oKSlcbiAgICAgIC5zdWJzY3JpYmUoKGNvbnRhaW5lcnNCb3VuZHM6IEVsZW1lbnRCb3VuZGluZ1Bvc2l0aW9ucykgPT4gdGhpcy5oYW5kbGVPblNjcm9sbChjb250YWluZXJzQm91bmRzKSk7XG5cbiAgfVxuXG4gIHByaXZhdGUgX2NoZWNrU2Nyb2xsRGlyZWN0aW9uKCl7XG4gICAgaWYodGhpcy5fc2Nyb2xsV2luZG93KXtcbiAgICAgdGhpcy5fc2Nyb2xsRGlyZWN0aW9uID0gKHdpbmRvdy5zY3JvbGxZID4gdGhpcy5fbGFzdFNjcm9sbFkpID8gJ2Rvd24nIDogJ3VwJztcbiAgICAgdGhpcy5fbGFzdFNjcm9sbFkgPSB3aW5kb3cuc2Nyb2xsWTtcbiAgICB9ZWxzZXtcbiAgICAgdGhpcy5fc2Nyb2xsRGlyZWN0aW9uID0gKHRoaXMuX2VsZW1lbnQubmF0aXZlRWxlbWVudC5zY3JvbGxUb3AgPiB0aGlzLl9sYXN0U2Nyb2xsWSkgPyAnZG93bicgOiAndXAnO1xuICAgICB0aGlzLl9sYXN0U2Nyb2xsWSA9IHRoaXMuX2VsZW1lbnQubmF0aXZlRWxlbWVudC5zY3JvbGxUb3A7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0Vmlld1BvcnRSdWxlcigpIHtcbiAgICByZXR1cm4gdGhpcy5fc2Nyb2xsV2luZG93ID8gdGhpcy5fd2luZG93UnVsZXIuZ2V0V2luZG93Vmlld1BvcnRSdWxlcigpIDogUG9zaXRpb25SZXNvbHZlci5nZXRCb3VuZGluZ0NsaWVudFJlY3QodGhpcy5fZWxlbWVudC5uYXRpdmVFbGVtZW50KTtcbiAgfVxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5fc2Nyb2xsU3VzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuX3Njcm9sbFN1c2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlT25TY3JvbGwoY29udGFpbmVyc0JvdW5kczogRWxlbWVudEJvdW5kaW5nUG9zaXRpb25zKSB7XG4gICAgLy8gY2hlY2sgb2Ygc2Nyb2xsIHVwIG9yIGRvd25cbiAgICAvLyBOb3RlOjogY2hlY2sgYWxsIGNoaWxkcmVuIGZyb20gcGFyZW50IGlmIGl0IGlzIGluIHZpZXcgb3Igbm90XG4gICAgLy8gZm9yIGNhY2hlIG9mIGxlc3MgaXRlcmF0aW9ucyBzdGFydCBmcm9tIHRoZSBsYXN0IHZpc2libGUgIGl0ZW0gdGhlbiBiYXNlZCBvbiBzY3JvbGwgdXAgYW5kIGRvd24gY2hlY2sgbGlzdCBmdXRoZXJcbiAgICBsZXQgdmlld1BvcnRPZmZzZXRSZWN0ID0gUG9zaXRpb25SZXNvbHZlci5vZmZzZXRSZWN0KGNvbnRhaW5lcnNCb3VuZHMsIHRoaXMuX3ZpZXdQb3J0T2Zmc2V0KTtcbiAgICBsZXQgdmlzaWJsZUNoaWxkcmVuOiBBcnJheTxhbnk+ID0gW107XG4gICAgaWYgKHRoaXMuX2ludmlld0NoaWxkcmVuKSB7XG4gICAgICB2aXNpYmxlQ2hpbGRyZW4gPSB0aGlzLl9pbnZpZXdDaGlsZHJlbi50b0FycmF5KCkuZmlsdGVyKChjaGlsZDogSW52aWV3SXRlbURpcmVjdGl2ZSkgPT4ge1xuICAgICAgICBsZXQgZWxlbWVudE9mZnNldFJlY3QgPSBQb3NpdGlvblJlc29sdmVyLm9mZnNldFJlY3QoY2hpbGQuZ2V0RUxlbWVudFJlY3QoKSwgdGhpcy5fb2Zmc2V0KTtcbiAgICAgICAgcmV0dXJuIGNoaWxkLmlzVmlzaWJsZSgpICYmIFBvc2l0aW9uUmVzb2x2ZXIuaW50ZXJzZWN0UmVjdChlbGVtZW50T2Zmc2V0UmVjdCwgdmlld1BvcnRPZmZzZXRSZWN0KTtcbiAgICAgIH0pO1xuICAgICAgaWYgKHRoaXMuX2Jlc3RNYXRjaCkge1xuICAgICAgICBsZXQgYmVzdE1hdGNoQ2hpbGQ6IEludmlld0l0ZW1EaXJlY3RpdmU7XG4gICAgICAgIGlmICh2aXNpYmxlQ2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgICAgdmlzaWJsZUNoaWxkcmVuLnJlZHVjZSgoZGlzdGFuY2U6IG51bWJlciwgY3VyckNoaWxkOiBJbnZpZXdJdGVtRGlyZWN0aXZlKSA9PiB7XG4gICAgICAgICAgICBsZXQgX2Rpc3RhbmNlID0gUG9zaXRpb25SZXNvbHZlci5kaXN0YW5jZSh2aWV3UG9ydE9mZnNldFJlY3QsIFBvc2l0aW9uUmVzb2x2ZXIub2Zmc2V0UmVjdChjdXJyQ2hpbGQuZ2V0RUxlbWVudFJlY3QoKSwgdGhpcy5fb2Zmc2V0KSk7XG4gICAgICAgICAgICBpZiAoZGlzdGFuY2UgPiBfZGlzdGFuY2UpIHtcbiAgICAgICAgICAgICAgYmVzdE1hdGNoQ2hpbGQgPSBjdXJyQ2hpbGQ7XG4gICAgICAgICAgICAgIHJldHVybiBfZGlzdGFuY2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZGlzdGFuY2U7XG4gICAgICAgICAgfSwgSW5maW5pdHkpO1xuICAgICAgICB9XG4gICAgICAgIGxldCBkYXRhOmFueSA9ICBiZXN0TWF0Y2hDaGlsZD9iZXN0TWF0Y2hDaGlsZC5nZXREYXRhKCk6IHt9O1xuICAgICAgICBkYXRhLmRpcmVjdGlvbiA9IHRoaXMuX3Njcm9sbERpcmVjdGlvbjtcbiAgICAgICAgdGhpcy5fem9uZS5ydW4oKCkgPT4gdGhpcy5pbnZpZXcuZW1pdChkYXRhKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsZXQgZGF0YTphbnkgPSB7fTtcbiAgICAgICAgZGF0YS5pbnZpZXcgPSAgdmlzaWJsZUNoaWxkcmVuLm1hcCgodmM6IEludmlld0l0ZW1EaXJlY3RpdmUpID0+IHZjLmdldERhdGEoKSk7XG4gICAgICAgIGRhdGEuZGlyZWN0aW9uID0gdGhpcy5fc2Nyb2xsRGlyZWN0aW9uO1xuICAgICAgICB0aGlzLl96b25lLnJ1bigoKSA9PiB0aGlzLmludmlldy5lbWl0KGRhdGEpKTtcbiAgICAgIH1cblxuICAgIH1cbiAgfVxuXG59XG5cblxuLy8gIGludmlldy1jb250YWluZXIgLT4gaW52aWV3LWl0ZW0gLT5cblxuLy8gIHNjcm9sbFdpbmRvdyA9ICB0cnVlIC0+IHdpbGwgdGVzdCBpdCBhZ2FpbnN0IHRoZSB3aW5kb3cgc2Nyb2xsIGV2ZW50IHdpdGggY29udGFpbmVyLlxuLy8gIHNjcm9sbFdpbmRvdyA9IGZhbHNlIC0+IG1lYW5zIHdlIG5lZWQgdG8gYXR0YWNoIHNjcm9sbCBldmVudCBvbiB0aGlzIGNvbnRhaW5lci5cblxuLy8gaW52aWV3IC0+ICBkaXJlY3RseSB1c2VkIGFnYWluc3QgdGhlIHdpbmRvdy5cbiJdfQ==